
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>HKDSE AI Writing Tool</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 800px; margin: 40px auto; padding: 20px; }
    label { display: block; margin-top: 20px; font-weight: bold; }
    select, input, button, pre { width: 100%; padding: 10px; margin-top: 5px; }
    button { background-color: #1e40af; color: white; border: none; cursor: pointer; }
    button:hover { background-color: #1d4ed8; }
    pre { background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 4px; min-height: 150px; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h1>HKDSE English Writing AI</h1>
  <p>Generate Band 5 / 5* / 5** DSE-level writing and examiner feedback.</p>

  <label for="type">Writing Type</label>
  <select id="type">
    <option value="blog">Blog</option>
    <option value="speech">Speech</option>
    <option value="letter to the editor">Letter to the Editor</option>
    <option value="formal letter">Formal Letter</option>
    <option value="proposal">Proposal</option>
    <option value="article">Article</option>
    <option value="one-sided argumentative essay">One-sided Argumentative Essay</option>
    <option value="two-sided argumentative essay">Two-sided Argumentative Essay</option>
  </select>

  <label for="level">Target Band</label>
  <select id="level">
    <option value="5">5</option>
    <option value="5*">5*</option>
    <option value="5**">5**</option>
  </select>

  <label for="topic">Topic</label>
  <input type="text" id="topic" placeholder="e.g. Should school uniforms be mandatory?" />

  <button onclick="generateWriting()">Generate Writing</button>

  <label for="output">Generated Writing</label>
  <pre id="output">Your AI writing will appear here...</pre>

  <label for="comment">Examiner Feedback</label>
  <pre id="comment">Click 'Generate Feedback' to get examiner response.</pre>
  <button onclick="generateFeedback()">Generate Feedback</button>

  <script>
    let cachedWriting = "";

    function getWritingPrompt(type, level, topic) {
      const baseIntro = \`You are an HKDSE English examiner. Write a Level \${level} \${type} on the topic: "\${topic}".\`;
      const endNote = "The writing must include at least 7 well-developed paragraphs.";

      const textTypeHints = {
        "blog": "Use an engaging and reflective tone. Write as if addressing teenage readers on a personal blog. Include personal experience or opinion.",
        "speech": "Use rhetorical questions and inclusive language like 'we' or 'you'. Begin with a greeting and end with a thank you.",
        "letter to the editor": "Use a persuasive and formal tone. Begin with 'Dear Editor' and end with your name. Include a strong stance and at least two solutions.",
        "formal letter": "Follow the format of a formal letter with an opening, body, and closing. Use polite and respectful tone throughout.",
        "proposal": "Structure into sections with subheadings (e.g. Purpose, Benefits, Implementation). Use formal tone and bullet-style logic.",
        "article": "Use a semi-formal tone, a catchy introduction, and informative middle. End with a reflective conclusion. Assume readers are Young Post audience.",
        "one-sided argumentative essay": "Write an essay taking a strong stance. Each paragraph should support your view logically with examples. No opposing views.",
        "two-sided argumentative essay": "Include both sides of the argument with fair discussion. Conclude by clearly stating your final opinion."
      };

      return \`\${baseIntro}\n\${textTypeHints[type] || ""}\n\${endNote}\`;
    }

    async function generateWriting() {
      const topic = document.getElementById("topic").value;
      const type = document.getElementById("type").value;
      const level = document.getElementById("level").value;
      const output = document.getElementById("output");
      const comment = document.getElementById("comment");

      output.innerText = "Generating writing...";
      comment.innerText = "Waiting for feedback generation...";

      const prompt = getWritingPrompt(type, level, topic);

      const response = await fetch("/api/generate", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ topic: prompt, type: "article", level })  // force article as base type for logic
      });

      if (!response.ok) {
        output.innerText = "⚠️ API Error. Please check server logs.";
        return;
      }

      const data = await response.json();
      cachedWriting = data.writing;
      output.innerText = cachedWriting || "⚠️ No writing generated.";
    }

    async function generateFeedback() {
      const comment = document.getElementById("comment");
      const level = document.getElementById("level").value;

      if (!cachedWriting) {
        comment.innerText = "⚠️ Please generate writing first.";
        return;
      }

      comment.innerText = "Generating feedback...";

      const response = await fetch("/api/feedback", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ writing: cachedWriting, level })
      });

      if (!response.ok) {
        comment.innerText = "⚠️ API Error. Please check server logs.";
        return;
      }

      const data = await response.json();
      comment.innerText = data.feedback || "⚠️ No feedback returned.";
    }
  </script>
</body>
</html>
